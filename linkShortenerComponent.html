<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://kairoscloud.github.io/main/globalFirebase.js"></script>
<link
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
    rel="stylesheet"
/>
<style>
    .clickableLink {
        cursor: pointer;
        color: #0c3d6d;
        font-size: 10pt;
        margin-top: 10px;
    }

    #PRDLink{
        margin-left: 10.8em;
    }

    .unclickableLink {
        cursor: not-allowed;
        color: #a0a0a0;
        font-size: 10pt;
        margin-top: 10px;
        margin-bottom: -10px;
    }

    .fieldLabel {
        font-size: 11pt !important;
        font-weight: 500 !important;
        color: #2c3538;
        margin-top: 20px;
        margin-bottom: 7px;
    }

    #deleteCampaign {
        font-weight: 500;
        color: red !important;
        text-align: center;
        padding: 9px 11px;
        text-decoration: none;
        font-size: 14px;
        background-color: white;
        border: 1px solid red;
        border-radius: 5px;
        margin: 8px;
        color: #2c3538;
        cursor: pointer;
    }

    #save {
        float: right;
        font-weight: 500;
        color: #31324a;
        text-align: center;
        padding: 9px 11px;
        text-decoration: none;
        font-size: 14px;
        background-color: white;
        border: 1px solid #d1d5de;
        border-radius: 5px;
        margin: 8px;
        color: #2c3538;
        cursor: pointer;
    }

    .greyedOut {
        background-color: #f0f0f0 !important; /* Light grey background */
        border: 1px solid #d1d5de !important;
        color: #a0a0a0 !important; /* Light grey text */
        cursor: not-allowed !important; /* Change cursor to indicate disabled state */
    }

    .ghlText {
        font-family: "Roboto", sans-serif;
        font-weight: 400;
        font-style: normal;
        color: #2c3538;
        font-size: 12pt;
    }

    .input-field {
        padding: 12px 10px; /* Adjust padding to match button styles */
        font-size: 14px; /* Match font size with button styles */
        border: 1px solid #d1d5de; /* Match border style with button styles */
        border-radius: 5px; /* Match border radius with button styles */
        color: #2c3538; /* Match text color with button styles */
        width: auto;
        margin: -5px;
        margin-top: -15px;
    }

    .input-field:focus {
        border: 1px solid #d1d5de;
        outline: none;
    }

    .dropdown {
        margin-top: 3px;
        margin-bottom: 8px;
        margin: 3px;
        margin-right: -6px;
    }

    .dropdown select {
        padding: 5px 5px;
        font-size: 14px;
        border: 1px solid #d1d5de;
        border-radius: 5px;
        color: #2c3538;
        box-sizing: border-box;
        background-color: #ffffff;
        cursor: pointer;
        appearance: none; /* Remove default arrow on some browsers */
    }

    .dropdown select:focus {
        outline: none;
        border-color: #165ef0;
    }

    .dropdown .chevron {
        transform: translateX(-25px);
    }

    .manageButton {
        float: right;
        right: 10px;
        font-weight: 500;
        color: #31324a;
        text-align: center;
        padding: 9px 11px;
        text-decoration: none;
        font-size: 14px;
        background-color: transparent;
        border: 1px solid #d1d5de;
        border-radius: 5px;
        margin: 8px;
        color: #2c3538;
        cursor: pointer;
    }

    .manageButton:hover {
        background-color: #f0f0f0;
    }

    .saveNew {
        float: right;
        color: #31324a;
        text-align: center;
        padding: 9px 11px;
        text-decoration: none;
        font-size: 14px;
        background-color: #165ef0;
        border-radius: 5px;
        margin: 8px;
        color: white;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid #165eff;
    }

    .delete {
        float: right;
        color: white;
        text-align: center;
        padding: 9px 11px;
        text-decoration: none;
        font-size: 14px;
        background-color: #f03434; /* Red color for delete action */
        border-radius: 5px;
        margin: 8px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid #f03434; /* Matching border color */
    }

    #domError {
        /* error in the bottom right */
        position: absolute;
        bottom: 1.5em;
        right: 1em;
        /* put text in center */
        display: flex;
        align-items: center;
        background-color: #fcf0f0;
        color: lightcoral;
        padding: 5px;
        border: 1px solid lightcoral;
        border-radius: 3px;
        /* glowing red shadow for box*/
        box-shadow: 0 0 1px #f03434;
        height: 3em;
        padding-left: 4em;
        padding-right: 1em;
        max-width: 33em;
    }

    #warningTriangle {
        position: absolute;
        left: 0.3em;
        font-size: 2.5em;
        margin-right: 0.5em;
    }

    .swipeIn {
        display: flex !important;
        animation:
            swipeInEffect 0.3s ease-in-out,
            fadeOut 1s ease-in-out 6s forwards;
    }

    @keyframes swipeInEffect {
        from {
            opacity: 0;
            transform: translateY(100%);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeOut {
        to {
            opacity: 0;
        }
    }

    .exitX {
        height: 1em;
        width: 1em;
        background-color: #f0f0f0;
        cursor: pointer;
        padding: 0.2em;
        border-radius: 0.2em;
        float: right;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.5em;
    }

    .exitX:hover {
        background-color: #e0e0e0;
    }

</style>
<body class="ghlText">
    <div>
        <span
            type="text"
            class="input-field ghlText"
            style="width: 15%; border-right: none; margin-right: -5px"
        >
            <span class="dropdown">
                <select id="domainSelect" oninput="domainInput()">
                    <option value="custom">
                        Custom link        
                    </option>
                    <!-- Domain options will be populated by JavaScript -->
                </select>
                <svg
                    class="chevron"
                    width="12"
                    height="12"
                    viewBox="0 0 12 12"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    id="chevronname"
                >
                    <path
                        d="M4.5 5.5L7.5 8.5L10.5 5.5"
                        stroke="#2c3538"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    />
                </svg>
            </span>
        </span>
        <input
            id="pathURLBox"
            placeholder="path-to-my-page"
            oninput="pathInput()"
            value=""
            style="
                width: 48%;
                border-top-left-radius: 0;
                border-bottom-left-radius: 0;
                margin-right: 5%;
                outline: none !important;
            "
            class="input-field"
            type="text"
        />
        <span class="exitX" onclick="outwardMessage('collapse')">
            <svg
                width="100"
                height="100"
                viewBox="0 0 100 100"
                xmlns="http://www.w3.org/2000/svg"
            >
                <line
                    x1="20"
                    y1="60"
                    x2="50"
                    y2="30"
                    stroke="white"
                    stroke-width="10"
                    stroke-linecap="round"
                />
                <line
                    x1="50"
                    y1="30"
                    x2="80"
                    y2="60"
                    stroke="white"
                    stroke-width="10"
                    stroke-linecap="round"
                />
            </svg>
        </span>
    </div>
    <div style="white-space: nowrap; display: none" id="optionalFunnelWrapper">
        <div style="margin-bottom: 1px; font-size: 11pt; margin-top: 25px; margin-bottom: 25px; color: #9d9d9d;">
            Import from funnel (optional)
        </div>
        <!-- start 'optional funnel' -->
        <span style="background-color: white;
                    display: inline-block;
                    border: 1px solid #e0e0e0;"
                    class="input-field"
                    id="funnelSelectWrapperOptional">

                        <span class="dropdown">
                            <select
                                id="funnelSelectOptional"
                                style="
                                    margin: -10px;
                                    margin-left: -4px;
                                    margin-right: -6px;
                                    color: #9d9d9d;
                                "
                                oninput="optionalFunnelInput()"
                            >
                            </select>
                            <svg
                                class="chevron"
                                width="12"
                                height="12"
                                viewBox="0 0 12 12"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                id="chevronname"
                            >
                                <path
                                    d="M4.5 5.5L7.5 8.5L10.5 5.5"
                                    stroke="#9d9d9d"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                        </span>
        </span>
        <!-- end 'optional funnel' -->
    </div>
    <div style="white-space: nowrap; display: block" id="allOtherWrapper">
        <div style="margin-bottom: 1px; font-size: 11pt; margin-top: 22px">
            Redirects to...
        </div>
        <br />

        <div>
            <span
                class="input-field ghlText"
                id="typeContaner"
                style="
                    width: 9em !important;
                    border-right: none;
                    margin-right: -5px;
                    display: inline-block;
                    padding: 12px 10px;
                "
            >
                <span class="dropdown">
                    <select
                        id="typeSelect"
                        oninput="typeInput()"
                        style="
                            margin: -10px;
                            margin-left: -4px;
                            margin-right: 0;
                        "
                    >
                        <option value="Funnel">Funnel              </option>
                        <!-- <option value="SMS"></option>
                        <option value="Phone">Phone</option>
                        <option value="Email">Email</option> -->
                        <option value="URL">URL</option>
                    </select>
                    <svg
                        class="chevron"
                        width="12"
                        height="12"
                        viewBox="0 0 12 12"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        id="chevronname"
                    >
                        <path
                            d="M4.5 5.5L7.5 8.5L10.5 5.5"
                            stroke="#2c3538"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        />
                    </svg>
                </span>
            </span>
            <span style="background-color: white;
                        border-top-left-radius: 0;
                        border-bottom-left-radius: 0;
                        display: inline-block;"
                        class="input-field"
                        id="funnelSelectWrapper">

                            <span class="dropdown">
                                <select
                                    id="funnelSelect"
                                    style="
                                        margin: -10px;
                                        margin-left: -4px;
                                        margin-right: -6px;
                                    "
                                    oninput="funnelInput()"
                                >
                                </select>
                                <svg
                                    class="chevron"
                                    width="12"
                                    height="12"
                                    viewBox="0 0 12 12"
                                    fill="none"
                                    xmlns="http://www.w3.org/2000/svg"
                                    id="chevronname"
                                >
                                    <path
                                        d="M4.5 5.5L7.5 8.5L10.5 5.5"
                                        stroke="#2c3538"
                                        stroke-width="1.5"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                </svg>
                            </span>
            </span>
                <!-- display = inline-block when visible -->
            <span id="abcWrapper" style="display:none">
            <input
                id="a"
                placeholder="recipient"
                oninput=""
                value=""
                style="
                    width: 48%;
                    border-top-left-radius: 0;
                    border-bottom-left-radius: 0;
                    border-bottom-right-radius: 0;
                    margin-right: 5%;
                    outline: none !important;
                "
                class="input-field"
                type="text"
            />
            <div>
                <input
                    id="b"
                    placeholder="subject"
                    oninput=""
                    value=""
                    style="
                        width: 48%;
                        border-radius: 0;
                        margin-right: 5%;
                        outline: none !important;
                        margin-top: 4px !important;
                        position: relative;
                        left: 9em;
                        margin-left: 10px;
                    "
                    class="input-field"
                    type="text"
                />
            </div>
            <div>
                <textarea
                    id="c"
                    placeholder="body"
                    oninput=""
                    value=""
                    style="
                        width: 48%;
                        height: 7em;
                        border-radius: 0;
                        border-bottom-left-radius: 5px;
                        border-bottom-right-radius: 5px;
                        margin-right: 5%;
                        outline: none !important;
                        margin-top: 4px !important;
                        position: relative;
                        left: 9em;
                        margin-left: 10px;
                        resize: none;
                    "
                    class="input-field ghlText"
                    type="text"
                /></textarea>
            </div>
            </span>
        </div>
    </div>
    <div id="PRDLink" class="clickableLink" style="display: none" onclick="openPRDLink()">

    </div>
    <button class="saveNew" id="compSaveButton" style="position: absolute; right: 0; bottom: 0;" onclick="save()">Publish</button>
</body>
<script>
    // This page is being embedded as an iframe. We need to get all the following params from the embedded URL: redirectID, locationID, locationAccessKey, and ComponentID
    let urlParams = new URLSearchParams(window.location.search);
    let locationID = urlParams.get("locationID");
    let locationAccessKey = ""; // Will be fetched
    let componentID = urlParams.get("componentID");
    let savedURL = urlParams.get("savedURL");
    // let jdlocationAccessKey = ""; // REMOVED
    let docID = urlParams.get("docID");
    let redirectID = ""; // Will store the ID of the GHL redirect, if applicable
    let domainList = []; // Will be populated by getDomainList()

    console.log({ locationID, componentID, savedURL, docID });

    // all elements
    let allOtherWrapper = document.getElementById("allOtherWrapper");
    let pathURLBox = document.getElementById("pathURLBox");
    let domainSelect = document.getElementById("domainSelect");
    let typeSelect = document.getElementById("typeSelect");
    let abcWrapper = document.getElementById("abcWrapper");
    let funnelSelect = document.getElementById("funnelSelect");
    let funnelSelectWrapper = document.getElementById("funnelSelectWrapper");
    let saveButton = document.getElementById("compSaveButton");
    let prdLink = document.getElementById("PRDLink");
    let funnelSelectOptional = document.getElementById("funnelSelectOptional");
    let optionalFunnelWrapper = document.getElementById("optionalFunnelWrapper");


    // body components
    let a = document.getElementById("a");
    let b = document.getElementById("b");
    let c = document.getElementById("c");

    let validPath = false;
    let prdLinkText = "";
    let subConfig = "Funnel"; // Default subConfig

    // Helper to determine which GHL locationId to use for redirect operations
    function getGhlLocationIdForDomain(domain) {
        if (domain === "jostens.co") {
            return "owNEzpbrfBjp4weSARXD"; // Special location for jostens.co
        }
        return locationID; // For all other client-imported domains, use their own locationID
    }

    function populateDomainDropdown() {
        domainSelect.innerHTML = '<option value="custom">Custom link        </option>';
        domainList.forEach(domain => {
            const option = document.createElement('option');
            option.value = domain;
            let displayText = domain + "/";
            const baseLength = displayText.length;
            if (baseLength < 12) {
                displayText += '     ';
            } else if (baseLength < 16) {
                displayText += '   ';
            } else if (baseLength < 20) {
                displayText += ' ';
            }
            option.innerHTML = displayText;
            domainSelect.appendChild(option);
        });
    }

    async function getLeadConnectorAccessToken() {
        if (locationAccessKey) return; // Already fetched or provided

        try {
            const doc = await firestore.collection("tokens").doc(locationID).get();
            if (doc.exists && doc.data().locationAccessToken) {
                locationAccessKey = doc.data().locationAccessToken;
                console.log("Fetched locationAccessKey for locationID:", locationID);
            } else {
                console.error("Could not fetch locationAccessKey for locationID:", locationID);
                outwardMessage("domError(Error: Missing API access token.)");
            }
        } catch (error) {
            console.error("Error fetching locationAccessKey:", error);
            outwardMessage("domError(Error: Failed to fetch API access token.)");
        }
    }

    // Initial loading sequence
    getDomainList().then(() => {
        populateDomainDropdown(); // Populate dropdown after fetching list

        let matchedDomain = null;
        let pathFromSavedURL = "";
        let isCustomSavedURL = true;

        if (savedURL) {
            for (const domain of domainList) {
                if (savedURL.startsWith("https://" + domain + "/")) {
                    matchedDomain = domain;
                    pathFromSavedURL = savedURL.substring(("https://" + domain + "/").length);
                    isCustomSavedURL = false;
                    break;
                }
            }
        }

        getLeadConnectorAccessToken().then(() => {
            getFunnelList().then((funnelList) => {
                funnelSelect.innerHTML = funnelList;
                funnelSelectOptional.innerHTML = `<option value="null">Select funnel...</option>` + funnelList;

                if (!isCustomSavedURL && matchedDomain) {
                    getLink(pathFromSavedURL, matchedDomain).then((redirectObj) => {
                        if (redirectObj) {
                            redirectID = redirectObj._id;
                            console.log(`Found redirect for '${pathFromSavedURL}' on domain '${matchedDomain}'! RedirectID: ${redirectID}`);
                            configManagedDomainLink(redirectObj, matchedDomain, pathFromSavedURL);
                        } else {
                            console.log(`No redirect found for '${pathFromSavedURL}' on domain '${matchedDomain}'. Treating as new.`);
                            configManagedDomainLink(null, matchedDomain, pathFromSavedURL);
                        }
                    });
                } else {
                    configCustomLink(savedURL && isCustomSavedURL ? savedURL : null);
                }
            });
        });
    });

    function configCustomLink(prefillUrl = null) {
        allOtherWrapper.style.display = "none";
        optionalFunnelWrapper.style.display = "block";
        prdLink.style.display = "none";
        domainSelect.value = "custom";
        pathURLBox.placeholder = "https://example.com";
        pathURLBox.value = prefillUrl ? prefillUrl : "";
        pathURLBox.style.border = "1px solid #d1d5de";
        pathURLBox.style.backgroundColor = "white";
        saveButton.classList.remove("greyedOut");
        validPath = true;
    }

    function configManagedDomainLink(redirectObj, domain, path) {
        pathURLBox.value = path;
        domainSelect.value = domain;
        allOtherWrapper.style.display = "block";
        optionalFunnelWrapper.style.display = "none";
        pathURLBox.placeholder = "path-to-my-page";

        let target = redirectObj ? redirectObj.target : "";
        let importedType = redirectObj ? getType(target) : "Funnel";

        fillFields(target, importedType);
        typeSelect.value = importedType;
        subConfig = importedType;
        eval("subConfig" + importedType + "()");

        if (redirectObj) {
            pathInput();
        } else {
            if (importedType === "Funnel") {
                if (funnelSelect.options.length > 0) {
                    funnelSelect.selectedIndex = 0;
                    funnelInput();
                }
            }
            pathInput();
        }
    }

    function getType(target){
      if(target.includes("params=sms")){ return "SMS"; }
      if(target.includes("params=mailto")){ return "Email"; }
      if(target.includes("params=tel")){ return "Phone"; }
      if(target.includes("https://app.kairoscloud.io/v2/preview/") && (target.includes("?ghlFunnelID") || !target.includes("¶ms="))){ return "Funnel"; }
      if(target.includes("sites.kairoscloud.io") && target.includes("?&locationID=")){ return "Funnel"; } // For new funnel links
      if(target.includes("http")){ return "URL"; }
      return "Funnel"; // Default
    }

    function fillFields(target, importedType){
      console.log("fillFields target:", target, "type:", importedType);
      if (!target) return;

      let params = "";
      if (target.includes("¶ms=")) {
        params = decodeURIComponent(target.split("¶ms=")[1]);
      }

      a.value = ""; b.value = ""; c.value = ""; // Clear fields

      if(importedType == "SMS" && params.startsWith("sms:")){
        let recipient = params.split("sms:")[1].split("?")[0];
        let message = params.includes("body=") ? params.split("body=")[1] : "";
        a.value = recipient;
        c.value = message;
      }
      if(importedType == "Email" && params.startsWith("mailto:")){
        let recipient = params.split("mailto:")[1].split("?")[0];
        let subject = params.includes("subject=") ? params.split("subject=")[1].split("&")[0] : "";
        let body = params.includes("body=") ? params.split("body=")[1] : "";
        a.value = recipient;
        b.value = subject;
        c.value = body;
      }
      if(importedType == "Phone" && params.startsWith("tel:")){
        let recipient = params.split("tel:")[1];
        a.value = recipient;
      }
      if(importedType == "Funnel"){
        let funnelID = "";
        if (target.includes("?ghlFunnelID=")) { // Check with '='
            funnelID = target.split("?ghlFunnelID=")[1];
        } else if (target.includes("https://app.kairoscloud.io/v2/preview/")) {
            funnelID = target.split("https://app.kairoscloud.io/v2/preview/")[1].split("?")[0];
        } else if (target.includes("sites.kairoscloud.io/")) {
             const parts = target.split("sites.kairoscloud.io/");
             if (parts.length > 1) funnelID = parts[1].split("?")[0];
        }
        funnelSelect.value = funnelID;
        if (funnelSelect.value !== funnelID && funnelID) { // If ID not found, log
            console.warn("Funnel ID", funnelID, "not found in dropdown.");
        }
      }
      if(importedType == "URL"){
        a.value = target;
      }
    }

    function domainInput(){
      const selectedDomain = domainSelect.value;
      if (selectedDomain === "custom") {
        configCustomLink();
        pathURLBox.value = "";
      } else {
        allOtherWrapper.style.display = "block";
        optionalFunnelWrapper.style.display = "none";
        pathURLBox.placeholder = "path-to-my-page";
        pathURLBox.value = "";

        typeSelect.value = "Funnel";
        subConfig = "Funnel";
        subConfigFunnel();

        if (funnelSelect.value) {
             outwardMessage("PRD(" + funnelSelect.value + ")");
        } else {
            prdLink.innerText = "";
            prdLinkText = "";
        }
        pathInput();
      }
    }

    function typeInput(){
        let type = typeSelect.value;
        eval("subConfig" + type + "()");
        subConfig = type;
    }

    function subConfigSMS(){
      funnelSelectWrapper.style.display = "none";
      abcWrapper.style.display = "inline";
      prdLink.style.display = "none";
      configField(a, "inline", "Recipient, ex. (123) 456-789");
      configField(b, "none", "");
      configField(c, "inline", "Message");
    }
    function subConfigEmail(){
      funnelSelectWrapper.style.display = "none";
      abcWrapper.style.display = "inline";
      prdLink.style.display = "none";
      configField(a, "inline", "Recipient, ex. example@mail.com");
      configField(b, "inline", "Subject");
      configField(c, "inline", "Body");
    }
    function subConfigPhone(){
      funnelSelectWrapper.style.display = "none";
      abcWrapper.style.display = "inline";
      prdLink.style.display = "none";
      configField(a, "inline", "Recipient, ex. (123) 456-789");
      configField(b, "none", "");
      configField(c, "none", "");
    }
    function subConfigURL(){
      funnelSelectWrapper.style.display = "none";
      abcWrapper.style.display = "inline";
      prdLink.style.display = "none";
      configField(a, "inline", "URL, ex. https://example.com");
      configField(b, "none", "");
      configField(c, "none", "");
    }
    function subConfigFunnel(){
      funnelSelectWrapper.style.display = "inline-block";
      prdLink.style.display = "block";
      abcWrapper.style.display = "none";
      if (funnelSelect.value) { // Ensure funnelSelect has a value before sending message
         outwardMessage("PRD(" + funnelSelect.value + ")");
      } else {
        prdLink.innerText = ""; // Clear PRD link if no funnel selected
        prdLinkText = "";
      }
    }
    function configField(elem, display, placeholder){
      elem.style.display = display;
      elem.placeholder = placeholder;
    }

    async function getLink(path, domain) {
        if (!locationAccessKey) {
            console.error("getLink: locationAccessKey is missing.");
            return null;
        }
        const ghlLocationId = getGhlLocationIdForDomain(domain);
        const url =
            `https://services.leadconnectorhq.com/funnels/lookup/redirect/list?locationId=${ghlLocationId}&limit=20&offset=0&search=/` +
            path +
            "$";
        const options = {
            method: "GET",
            headers: {
                Authorization: "Bearer " + locationAccessKey,
                Version: "2021-07-28",
                Accept: "application/json",
            },
        };
        try {
            const response = await fetch(url, options);
            const data = await response.json();
            console.log("getLink response for domain", domain, ":", data);
            if (data.data && data.data.length > 0) {
                // Prefer exact match on domain and path if multiple results (though search=$ should limit)
                const foundRedirect = data.data.find(r => r.domain === domain && r.path === "/" + path);
                return foundRedirect || data.data[0];
            }
            return null;
        } catch (error) {
            console.error("Error in getLink:", error);
            return null;
        }
    }

    async function getFunnelList() {
      if (!locationAccessKey) {
          console.error("getFunnelList: locationAccessKey is missing.");
          return "";
      }
      let funnelListHTML = "";
      const url = `https://services.leadconnectorhq.com/funnels/funnel/list?locationId=${locationID}`;
      const options = {
          method: "GET",
          headers: {
              Authorization: "Bearer " + locationAccessKey,
              Version: "2021-07-28",
              Accept: "application/json",
          },
      };
      try {
          const response = await fetch(url, options);
          const data = await response.json();
          console.log("Funnel list data:",data);
          if (data.funnels) {
              data.funnels.forEach(funnel => {
                  if (!funnel.deleted) {
                      funnel.steps.forEach(step => {
                          if (step.pages && step.pages.length > 0) {
                             let siteID = step.pages[0]; // Assuming first page is the one to link
                             let displayName = shorten(funnel.name, 14) + " | " + shorten(step.name, 14);
                             funnelListHTML += `<option value="${siteID}">${displayName}      </option>`;
                          }
                      });
                  }
              });
          }
          return funnelListHTML;
      } catch (error) {
          console.error("Error fetching funnel list:", error);
          return "";
      }
    }

    function shorten(str, n){
      if(str.length > n){
        return str.substring(0, n) + "...";
      } else {
        return str;
      }
    }

    function outwardMessage(message) {
        window.parent.postMessage(componentID + "::" + message, "*");
    }

    async function save(){
      const selectedDomain = domainSelect.value;
      let path = pathURLBox.value;

      if(saveButton.classList.contains("greyedOut")){ return; }
      saveButton.innerHTML = "Saving...";
      saveButton.classList.add("greyedOut");

      if(selectedDomain === "custom"){
        if (redirectID) { // If previously a GHL link, delete it
            const originalDomainOfRedirect = domainList.find(d => savedURL && savedURL.startsWith("https://" + d + "/"));
            if (originalDomainOfRedirect) {
                 await deleteRedirect(redirectID, originalDomainOfRedirect);
            }
        }
        outwardMessage("success(" + path + ")['']"); // Path is the full custom URL
        outwardMessage("collapse");
        saveButton.innerHTML = "Publish";
        saveButton.classList.remove("greyedOut");
        return;
      }

      let target = "";
      if(subConfig == "SMS"){ target = "sms:" + a.value + "?body=" + encodeURIComponent(c.value); }
      if(subConfig == "Email"){ target = "mailto:" + a.value + "?subject=" + encodeURIComponent(b.value) + "&body=" + encodeURIComponent(c.value); }
      if(subConfig == "Phone"){ target = "tel:" + a.value; }
      if(subConfig == "URL"){ target = a.value; }
      if(subConfig == "Funnel"){
          // Use sites.kairoscloud.io for new funnel links
          target = "https://sites.kairoscloud.io/" + funnelSelect.value + "?&locationID=" + locationID + "&campaignID=" + docID;
          if(prdLinkText && prdLink.style.display !== "none" && prdLinkText.startsWith("https://app.kairoscloud.io/v2/preview/")) {
            // If PRD link was for an old style preview link, prefer that format if it was actively generated
            target = prdLinkText + (prdLinkText.includes("?") ? "&" : "?") + "ghlFunnelID=" + funnelSelect.value;
          }
      }

      if (prdLink.style.display !== "none" && prdLinkText && subConfig === "Funnel" && !target.includes(prdLinkText)) {
          // If PRD link text exists (from funnel selection) and it's a funnel type,
          // ensure the target uses this specific preview link if it's different from the sites.kairoscloud.io default.
          // This is complex as prdLinkText might be sites.kairoscloud already.
          // The logic above for funnel target aims to use sites.kairoscloud.io by default.
          // If prdLinkText is an app.kairoscloud.io link, it will be used.
      }


      if(subConfig == "SMS" || subConfig == "Phone" || subConfig == "Email"){
        target = "https://app.kairoscloud.io/v2/preview/oJPuhXJVm3KGa7C5c2BF?notrack=true¶ms=" + encodeURIComponent(target);
      }
      console.log("Final Target for redirect:", target);

      if (redirectID) {
          const originalDomainOfRedirect = domainList.find(d => savedURL && savedURL.startsWith("https://" + d + "/"));
          const originalPathOfRedirect = originalDomainOfRedirect ? savedURL.substring(("https://" + originalDomainOfRedirect + "/").length) : null;

          if (originalDomainOfRedirect && (originalDomainOfRedirect !== selectedDomain || originalPathOfRedirect !== path)) {
              console.log("Domain or path changed, deleting old redirect:", redirectID, "on", originalDomainOfRedirect);
              await deleteRedirect(redirectID, originalDomainOfRedirect);
              redirectID = ""; // Will get a new ID
          } else if (originalDomainOfRedirect && originalDomainOfRedirect === selectedDomain && originalPathOfRedirect === path) {
              // Path and domain are the same, this is an update to the target.
              // GHL's POST redirect can sometimes update if path/domain exists, or might need PUT.
              // For simplicity, deleting and recreating if target changes.
              console.log("Path and domain same, but target might change. Deleting and recreating.");
              await deleteRedirect(redirectID, originalDomainOfRedirect);
              redirectID = "";
          }
      }

      createRedirect(path, target, selectedDomain);
    }

    async function deleteRedirect(id, domain){
      if(id === ""){ console.log("No redirect ID to delete: skipping"); return; }
      if (!locationAccessKey) { console.error("deleteRedirect: locationAccessKey is missing."); return; }

      const ghlLocationId = getGhlLocationIdForDomain(domain);
      console.log(`Deleting redirect '${id}' for domain '${domain}' on location '${ghlLocationId}'`);
      const url = `https://services.leadconnectorhq.com/funnels/lookup/redirect/${id}?locationId=${ghlLocationId}`;
      const options = {
          method: "DELETE",
          headers: {
              Authorization: "Bearer " + locationAccessKey,
              Version: "2021-07-28",
              Accept: "application/json",
          },
      };
      try {
          const response = await fetch(url, options);
          if (response.ok) {
            console.log("Successfully deleted redirect:", id, await response.text());
          } else {
            console.error("Failed to delete redirect:", id, response.status, await response.text());
          }
      } catch (error) {
          console.error("Error in deleteRedirect:", error);
      }
    }

    async function createRedirect(path, target, domain) {
      if (!locationAccessKey) {
          console.error("createRedirect: locationAccessKey is missing.");
          saveButton.innerHTML = "Publish";
          saveButton.classList.remove("greyedOut");
          outwardMessage("domError(Error: Missing API access token.)");
          return;
      }
      console.log(`Creating redirect for domain '${domain}', path '/${path}' for target '${target}'`);
      const ghlLocationId = getGhlLocationIdForDomain(domain);
      const url = "https://services.leadconnectorhq.com/funnels/lookup/redirect";
      const options = {
          method: "POST",
          headers: {
              Authorization: "Bearer " + locationAccessKey,
              Version: "2021-07-28",
              "Content-Type": "application/json",
              Accept: "application/json",
          },
          body: JSON.stringify({
              locationId: ghlLocationId,
              domain: domain,
              path: "/" + path,
              target: target,
              action: "url"
          }),
      };
      try {
          const response = await fetch(url, options);
          const data = await response.json();
          console.log("createRedirect response:", data, "status:", response.status);
          processResult(data, response.status);
      } catch (error) {
          console.error("Error in createRedirect:", error);
          outwardMessage("domError(Could not create redirect: Network error.)");
          saveButton.innerHTML = "Publish";
          saveButton.classList.remove("greyedOut");
      }
    }

    function pathInput(){
      const selectedDomain = domainSelect.value;
      if (selectedDomain === "custom") {
          pathURLBox.style.border = "1px solid #d1d5de";
          pathURLBox.style.backgroundColor = "white";
          saveButton.classList.remove("greyedOut");
          validPath = true;
          return;
      }

      let path = pathURLBox.value;
      let oldPath = "";
      if (savedURL && savedURL.startsWith("https://" + selectedDomain + "/")) {
          oldPath = savedURL.substring(("https://" + selectedDomain + "/").length);
      }

      if (path === "" && !(path === oldPath && redirectID)) {
          pathURLBox.style.border = "1px solid lightcoral";
          pathURLBox.style.backgroundColor = "#EAD3D3";
          saveButton.classList.add("greyedOut");
          validPath = false;
          return;
      }

      shortenedLinkExists(path, selectedDomain).then((linkExists) => {
          if (path === oldPath && redirectID) {
              pathURLBox.style.border = "1px solid #d1d5de";
              pathURLBox.style.backgroundColor = "white";
              saveButton.classList.remove("greyedOut");
              validPath = true;
          } else if (!linkExists && isValidPath(path)) {
              pathURLBox.style.border = "1px solid green";
              pathURLBox.style.backgroundColor = "#D7EBC0";
              saveButton.classList.remove("greyedOut");
              validPath = true;
          } else {
              pathURLBox.style.border = "1px solid lightcoral";
              pathURLBox.style.backgroundColor = "#EAD3D3";
              saveButton.classList.add("greyedOut");
              validPath = false;
              if (linkExists && path !== oldPath) console.warn(`Path '${path}' on domain '${selectedDomain}' already exists.`);
              if (!isValidPath(path)) console.warn(`Path '${path}' has invalid characters.`);
          }
      });
    }

    function isValidPath(path) {
      const urlSafeRegex = /^[a-zA-Z0-9\-_.~]*$/; // Allow empty string for initial state, path="" handled by pathInput separately
      return urlSafeRegex.test(path);
    }

    async function shortenedLinkExists(path, domain) {
      if (path === "") return false; // An empty path doesn't "exist" in a way that blocks creation of a new link
      if (!locationAccessKey) { console.error("shortenedLinkExists: locationAccessKey is missing."); return true; /* err on safe side */ }

      const ghlLocationId = getGhlLocationIdForDomain(domain);
      const url =
          `https://services.leadconnectorhq.com/funnels/lookup/redirect/list?locationId=${ghlLocationId}&limit=1&offset=0&search=/` +
          path +
          "$";
      const options = {
          method: "GET",
          headers: {
              Authorization: "Bearer " + locationAccessKey,
              Version: "2021-07-28",
              Accept: "application/json",
          },
      };
      try {
          const response = await fetch(url, options);
          const data = await response.json();
          if (data.data && data.data.length > 0) {
              return data.data.some(r => r.domain === domain && r.path === "/" + path);
          }
          return false;
      } catch (error) {
          console.error("Error in shortenedLinkExists:", error);
          return true; // Err on the side of caution, assume it exists to prevent overwrite issues
      }
    }

    function processResult(data, status){
      console.log("Processing result - Status:", status, "Data:", data);
      if(status === 200 || status === 201){ // GHL POST often 201, GET/PUT/PATCH 200
        let resultData = data.redirect || data.data || data; // GHL response structure varies
        if (resultData && resultData.id && resultData.domain && resultData.path) {
            let shortenedLink = "https://" + resultData.domain + resultData.path;
            redirectID = resultData.id;
            savedURL = shortenedLink;
            outwardMessage("success(" + shortenedLink + ")[" + resultData.id + "]");
            outwardMessage("collapse");
        } else {
            console.error("Successful response but unexpected data structure:", data);
            // Check for specific GHL "path already exists" message more robustly
            if (typeof data.message === 'string' && data.message.toLowerCase().includes("path already exists")) {
                 outwardMessage(`domError(Path '/${pathURLBox.value}' already exists for domain '${domainSelect.value}'.)`);
            } else {
                 outwardMessage("domError(Link saved, but response format unexpected.)");
            }
        }
      } else {
        let errorMessage = "Could not shorten link.";
        if (data && data.message) {
            errorMessage += " " + data.message;
             if (data.message.toLowerCase().includes("path already exists")) {
                errorMessage = `Path '/${pathURLBox.value}' already exists for domain '${domainSelect.value}'.`;
                pathURLBox.style.border = "1px solid lightcoral";
                pathURLBox.style.backgroundColor = "#EAD3D3";
            }
        } else if (typeof data === 'string') {
            errorMessage += " " + data;
        }
        console.error("Error from API:", status, data, errorMessage);
        outwardMessage("domError(" + errorMessage + ")");
      }
      saveButton.innerHTML = "Publish";
      saveButton.classList.remove("greyedOut");
    }

    window.addEventListener('message', function(event) {
        processInwardMessage(event.data);
    }, false);

    function processInwardMessage(message){
      if(message.split("::")[0] == componentID && message.includes("inwardmsg") && !message.includes("inwardmsg::null")){
        console.log("Domain & path retrieved from parent: ", message);
        let url = message.split("::")[2].split(")")[0];
        url = "https://" + url.replace(/^www\./i, ""); // Remove www. case-insensitively
        if(message.includes("OPTIONALFUNNEL")){
          pathURLBox.value = url; // if it's from optional funnel, it's a full URL to be used as custom
          domainSelect.value = "custom"; // Switch to custom domain mode
          domainInput(); // Trigger domain input logic to update UI for custom
          pathURLBox.value = url; // Re-set value after domainInput might clear it
        } else {
          prdLink.innerText = "↳ " + shorten(url, 45);
          prdLinkText = url;
          // This URL is likely a funnel preview, update target if current type is Funnel
          if (subConfig === "Funnel") {
             // This might trigger an update to the 'target' in save() if prdLinkText is used.
          }
        }
      } else if (message.split("::")[0] == componentID && message.includes("inwardmsg::null") && !message.includes("OPTIONALFUNNEL")) {
        // Clear PRD link if parent sends null for the main funnel target
        prdLink.innerText = "";
        prdLinkText = "";
      }
    }

    function funnelInput(){
      console.log("Funnel selected, sending PRD message to parent for: " + funnelSelect.value);
      outwardMessage("PRD(" + funnelSelect.value + ")");
    }
    function optionalFunnelInput(){
      console.log("Optional funnel selected, sending PRD message to parent for: " + funnelSelectOptional.value);
      outwardMessage("PRD(" + funnelSelectOptional.value + ")OPTIONALFUNNEL");
    }
    function openPRDLink(){
      if (prdLinkText) {
         window.open(prdLinkText, "_blank");
      }
    }

    async function getDomainList() {
      let domainRef = firestore.collection("domains").doc(locationID);
      try {
        const doc = await domainRef.get();
        if (doc.exists) {
            domainList = doc.data().domainList || [];
            console.log("Domain list fetched: ", domainList);
            // Ensure "jostens.co" is in the list if not already (as per original assumption)
            if (!domainList.includes("jostens.co")) {
                // The prompt says "assume jostens.co is already in domainList"
                // If it's critical and might be missing, you could add it:
                // domainList.push("jostens.co");
                // However, sticking to the assumption that it's provided from Firestore.
            }
        } else {
            console.log("No domain list document found for locationID!", locationID);
            // Fallback: at least include jostens.co if nothing else, if that's a hard requirement
            // if (!domainList.includes("jostens.co")) domainList.push("jostens.co");
        }
      } catch (error) {
          console.log("Error getting domain list:", error);
          // Fallback if Firestore fails
          // if (!domainList.includes("jostens.co")) domainList.push("jostens.co");
      }
    }
</script>
